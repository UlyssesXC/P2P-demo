//@version=5
strategy("RSI Derivative with Volume and Consecutive Derivative Buy/Sell Condition", overlay=true)

// RSI计算
rsiLength = 14
rsiValue = ta.rsi(close, rsiLength)

// 计算RSI的一阶导数
rsiDerivative = ta.change(rsiValue)

// 计算前20个K线的平均成交量
volumeAvg = ta.sma(volume, 20)

// 定义买入条件：RSI连续3根K线的导数大于2，并且最后一根K线的RSI值大于50，且当前成交量大于前20根K线的平均成交量的5倍
buyCondition = (  rsiDerivative > 2) and (rsiValue > 50) and (volume > 5 * volumeAvg)

// 定义卖出条件：RSI连续2根K线的导数小于-1，且有持仓时才卖出
sellCondition = (rsiDerivative < -1[1] and rsiDerivative < -1) and strategy.position_size > 0

// 定义变量跟踪买入后K线的数量
var int barsSinceEntry = na

// 当满足买入条件时，买入并重置K线计数器
if (buyCondition and strategy.position_size == 0)
    strategy.entry("Buy", strategy.long)
    barsSinceEntry := 0  // 重置计数器

// 更新K线计数器
if (strategy.position_size > 0)
    barsSinceEntry += 1

// 绘制买入和卖出的点
plotshape(series=buyCondition, title="Buy", location=location.belowbar, color=color.green, style=shape.labelup, text="BUY")
plotshape(series=sellCondition, title="Sell", location=location.abovebar, color=color.red, style=shape.labeldown, text="SELL")

// 实现卖出策略
if (sellCondition)
    strategy.close("Buy")
